name: Terraform Lint and Security Checks

on:
  pull_request:
    branches:
      - main
    paths:
      - 'infra/**'
      - '.github/workflows/terraform_validate.yml'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode with verbose output'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  actions: read # Needed for uploading SARIF reports
  contents: read
  security-events: write
  pull-requests: write  # Allow workflow to comment on PRs
  id-token: write # Needed for OIDC Authentication

# Global environment variables
env:
  ERROR_HANDLING: true # Enable enhanced error handling

jobs:
  check-dependabot:
    name: Check if Dependabot PR
    runs-on: ubuntu-latest
    outputs:
      is_dependabot: ${{ steps.check-actor.outputs.is_dependabot }}
    steps:
      - name: Check if PR is from Dependabot
        id: check-actor
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" && "${{ github.actor_id }}" == "49699333" ]]; then
            echo "is_dependabot=true" >> $GITHUB_OUTPUT
            echo "PR is from Dependabot"
          else
            echo "is_dependabot=false" >> $GITHUB_OUTPUT
            echo "PR is not from Dependabot"
          fi

  lint-and-check:
    name: Lint and Security Checks
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: check-dependabot
    # Run for all PRs but handle Dependabot PRs specially

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0  # Required for proper GitLeaks scanning

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '18.x'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: "1.13.3"  # Pinning specific version

      - name: Terraform Init
        id: tf-init
        run: |
          echo "Running Terraform Init..."
          terraform init -backend=false
          if [ $? -ne 0 ]; then
            echo "::error::Terraform init failed! Check Terraform configuration files."
            exit 1
          fi
        working-directory: ./infra

      - name: Terraform Fmt
        id: tf-fmt
        run: |
          echo "Checking Terraform formatting..."

          # Capture files that need formatting
          FMT_OUTPUT=$(terraform fmt -check -recursive -diff 2>&1) || FMT_EXIT=$?

          if [ "${FMT_EXIT:-0}" -ne 0 ]; then
            echo "::error::Terraform format check failed! Run 'terraform fmt -recursive' locally to fix formatting issues."

            # Always show which files need formatting
            echo ""
            echo "Files that need formatting:"
            terraform fmt -check -recursive 2>&1 | grep -v "^$" || true

            # Show diff in debug mode or if requested
            if [ "${{ github.event.inputs.debug }}" == "true" ] || [ "${{ env.ERROR_HANDLING }}" == "true" ]; then
              echo ""
              echo "Formatting differences:"
              echo "$FMT_OUTPUT"
            fi

            exit 1
          fi

          echo "All Terraform files are properly formatted."
        working-directory: ./infra

      - name: Terraform Validate
        id: tf-validate
        run: |
          echo "Validating Terraform configuration..."

          # Run validation and capture both JSON and exit code
          terraform validate -json > validation_result.json 2>&1 || VALIDATE_EXIT=$?

          if [ "${VALIDATE_EXIT:-0}" -ne 0 ]; then
            echo "::error::Terraform validation failed! Check your Terraform files for errors."

            # Always show validation errors in a readable format
            echo ""
            echo "Validation errors:"
            cat validation_result.json | jq -r '.diagnostics[]? | "- [\(.severity | ascii_upcase)] \(.summary): \(.detail)"' 2>/dev/null || cat validation_result.json

            # Show full JSON output in debug mode
            if [ "${{ github.event.inputs.debug }}" == "true" ]; then
              echo ""
              echo "Full validation output:"
              cat validation_result.json | jq '.' 2>/dev/null || cat validation_result.json
            fi

            exit 1
          fi

          echo "Terraform configuration is valid."
        working-directory: ./infra

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@4cb9feea73331a35b422df102992a03a44a3bb33 # v6.2.1
        with:
          tflint_version: v0.58.1  # Specify a version (recommended)
          github_token: ${{ secrets.GITHUB_TOKEN }}  # Used to avoid rate limiting

      - name: Initialize TFLint plugins
        id: tflint-init
        run: |
          echo "Initializing TFLint plugins..."
          tflint --init
          if [ $? -ne 0 ]; then
            echo "::error::TFLint initialization failed!"
            exit 1
          fi
        working-directory: ./infra

      - name: Run TFLint
        id: tflint-run
        run: |
          echo "Running TFLint..."

          # Run TFLint and capture output
          tflint --format=json --force > tflint_result.json 2>&1 || TFLINT_EXIT=$?

          if [ "${TFLINT_EXIT:-0}" -ne 0 ]; then
            echo "::error::TFLint found issues in your Terraform configuration!"

            # Always show formatted errors
            echo ""
            echo "TFLint issues found:"
            cat tflint_result.json | jq -r '.issues[]? | "- [\(.severity | ascii_upcase)] \(.rule.name) in \(.range.filename):\(.range.start.line): \(.message)"' 2>/dev/null || echo "Failed to parse TFLint output"

            # Show full JSON output in debug mode
            if [ "${{ github.event.inputs.debug }}" == "true" ]; then
              echo ""
              echo "Full TFLint output:"
              cat tflint_result.json | jq '.' 2>/dev/null || cat tflint_result.json
            fi

            # Also create GitHub annotations for issues
            cat tflint_result.json | jq -r '.issues[]? | "::error file=\(.range.filename),line=\(.range.start.line),col=\(.range.start.column)::\(.message)"' 2>/dev/null || true

            exit 1
          fi

          echo "TFLint completed successfully with no issues."
        working-directory: ./infra

      - name: Install GitLeaks
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.28.0/gitleaks_8.28.0_linux_x64.tar.gz -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/
          rm gitleaks.tar.gz
          gitleaks version

      - name: GitLeaks Scan
        id: gitleaks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        run: |
          echo "Running GitLeaks scan with max archive depth..."
          gitleaks detect \
            --verbose \
            --max-archive-depth 50 \
            --report-format sarif \
            --report-path ./gitleaks-report.sarif \
            --source . \
            --exit-code 0 || true
          echo "GitLeaks scan completed"

      - name: Upload GitLeaks SARIF report
        if: success() || failure()  # Upload even if GitLeaks finds issues
        uses: github/codeql-action/upload-sarif@9b02dc2f60288b463e7a66e39c78829b62780db7 # v2.22.1
        with:
          directory: ./  # Ensure the report path is correct
          sarif_file: gitleaks-report.sarif
          category: gitleaks

      - name: Run Checkov action
        id: checkov
        uses: bridgecrewio/checkov-action@de3c276ef8118f7ce6bcb2e51d8dd3d65ac0ae36 # v12.1347.0
        with:
          framework: terraform
          download_external_modules: true
          directory: ./infra
          soft_fail: false  # Make workflow fail on Checkov failures
          output_format: sarif
          output_file_path: checkov-results.sarif  # Explicitly specify the output file path

      - name: Upload Checkov SARIF report
        if: success() || failure()  # Upload even if Checkov finds issues
        uses: github/codeql-action/upload-sarif@9b02dc2f60288b463e7a66e39c78829b62780db7 # v2.22.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          sarif_file: checkov-results.sarif
          category: checkov
          wait-for-processing: true  # Wait for processing to complete before proceeding



      - name: Summary
        if: always()  # Always run this step
        run: |
          echo "## Terraform Validation Results :clipboard:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show debug mode status if enabled
          if [ "${{ github.event.inputs.debug }}" == "true" ]; then
            echo "üîç **Debug Mode**: Enabled (verbose output shown)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Check Terraform Init
          if [ "${{ steps.tf-init.outcome }}" == "success" ]; then
            echo "‚úÖ **Terraform Init**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Terraform Init**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Check Terraform Format
          if [ "${{ steps.tf-fmt.outcome }}" == "success" ]; then
            echo "‚úÖ **Terraform Format**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Terraform Format**: Failed - Run 'terraform fmt -recursive' locally" >> $GITHUB_STEP_SUMMARY
            echo "   - Check step logs for list of files that need formatting" >> $GITHUB_STEP_SUMMARY
          fi

          # Check Terraform Validate
          if [ "${{ steps.tf-validate.outcome }}" == "success" ]; then
            echo "‚úÖ **Terraform Validate**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Terraform Validate**: Failed - Check configuration files" >> $GITHUB_STEP_SUMMARY
            echo "   - Check step logs for detailed validation errors" >> $GITHUB_STEP_SUMMARY
          fi

          # Check TFLint
          if [ "${{ steps.tflint-run.outcome }}" == "success" ]; then
            echo "‚úÖ **TFLint**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **TFLint**: Failed - Review linting errors" >> $GITHUB_STEP_SUMMARY
            echo "   - Check step logs for detailed linting issues" >> $GITHUB_STEP_SUMMARY
          fi

          # Check Checkov
          if [ "${{ steps.checkov.outcome }}" == "success" ]; then
            echo "‚úÖ **Checkov Security Check**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Checkov Security Check**: Failed - Security issues found" >> $GITHUB_STEP_SUMMARY
          fi

          # Check GitLeaks
          if [ "${{ steps.gitleaks.outcome }}" == "success" ]; then
            echo "‚úÖ **GitLeaks Scan**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **GitLeaks Scan**: Failed - Sensitive information detected" >> $GITHUB_STEP_SUMMARY
          fi

          # Add help message if any checks failed
          if [ "${{ steps.tf-fmt.outcome }}" != "success" ] || \
             [ "${{ steps.tf-validate.outcome }}" != "success" ] || \
             [ "${{ steps.tflint-run.outcome }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üí° **Tip**: Re-run this workflow with debug mode enabled for more verbose output:" >> $GITHUB_STEP_SUMMARY
            echo "   - Go to Actions ‚Üí Select this workflow ‚Üí Run workflow ‚Üí Enable 'debug mode'" >> $GITHUB_STEP_SUMMARY
          fi

  update-dependabot-pr:
    name: Update Dependabot PR Status
    needs: [check-dependabot, lint-and-check]
    runs-on: ubuntu-latest
    if: needs.check-dependabot.outputs.is_dependabot == 'true' && success()
    steps:
      - name: Comment on PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## Terraform Validation Passed ‚úÖ

              The Terraform provider update has been validated with:
              - ‚úÖ Terraform Init
              - ‚úÖ Terraform Format Check
              - ‚úÖ Terraform Validation
              - ‚úÖ TFLint Check
              - ‚úÖ Security Scanning

              This PR can pass all the checks to be tested and then merged.`
            });

            // Add 'terraform-validated' label to the PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['terraform-validated']
            });

  update-dependabot-pr-failure:
    name: Report Validation Failure on Dependabot PR
    needs: [check-dependabot, lint-and-check]
    runs-on: ubuntu-latest
    if: needs.check-dependabot.outputs.is_dependabot == 'true' && failure()
    steps:
      - name: Comment on PR about failure
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ‚ùå Terraform Validation Failed

              The Terraform provider update has failed validation. Please check the workflow logs for details.

              This may indicate that the provider update is not compatible with the current configuration.`
            });

            // Add 'terraform-validation-failed' label to the PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['terraform-validation-failed']
            });
