name: "CI-Deploy"
on:
  workflow_dispatch:
    inputs:
      azd_environment_name:
        description: "Name of the AZD Environment"
        required: true
        default: "dev"
      azure_location:
        description: "Azure location for the environment"
        required: true
        default: "eastus"
  push:
    # Run when commits are pushed to mainline branch (main or master)
    # Set this to the mainline branch you are using
    branches:
      - basic_wf

# GitHub Actions workflow to deploy to Azure using azd
# To configure required secrets for connecting to Azure, simply run `azd pipeline config --auth-type client-credentials`

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install azd
        uses: Azure/setup-azd@v2

      - name: Install Nodejs
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Login az
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in with Azure dev
        run: |
          $info = $Env:AZURE_CREDENTIALS | ConvertFrom-Json -AsHashtable;
          Write-Host "::add-mask::$($info.clientSecret)"

          az account set --subscription "$($info.subscriptionId)"

          azd auth login `
            --client-id "$($info.clientId)" `
            --client-secret "$($info.clientSecret)" `
            --tenant-id "$($info.tenantId)"
          
          azd config set auth.useAzCliAuth "true"
         
        shell: pwsh
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Provision Infrastructure
        env:
          AZURE_ENV_NAME: ${{ github.event.inputs.azd_environment_name }}
          AZURE_LOCATION: ${{ github.event.inputs.azure_location  }}          
          POWER_PLATFORM_USE_CLI: true
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        shell: pwsh
        run: |
          $info = $Env:AZURE_CREDENTIALS | ConvertFrom-Json -AsHashtable;
          Write-Host "::add-mask::$($info.clientSecret)"
          
          $env:AZURE_SUBSCRIPTION_ID="$($info.subscriptionId)"
          $env:ARM_TENANT_ID="$($info.tenantId)"
          $env:ARM_CLIENT_ID="$($info.clientId)"
          $env:ARM_CLIENT_SECRET="$($info.clientSecret)"

          $env:POWER_PLATFORM_TENANT_ID="$($info.tenantId)"
          $env:POWER_PLATFORM_CLIENT_ID="$($info.clientId)"
          $env:POWER_PLATFORM_CLIENT_SECRET="$($info.clientSecret)"

          azd env new --name $AZURE_ENV_NAME --location $AZURE_LOCATION --no-prompt
          azd env set POWER_PLATFORM_USE_CLI "true"
          azd provision --no-prompt

        
      - name: Azd down
        env:
            AZURE_ENV_NAME: ${{ github.event.inputs.azd_environment_name }}
            AZURE_LOCATION: ${{ github.event.inputs.azure_location }}
            AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        shell: pwsh
        run: |
          $info = $Env:AZURE_CREDENTIALS | ConvertFrom-Json -AsHashtable;
          Write-Host "::add-mask::$($info.clientSecret)"
          
          $env:AZURE_SUBSCRIPTION_ID="$($info.subscriptionId)"
          $env:ARM_TENANT_ID="$($info.tenantId)"
          $env:ARM_CLIENT_ID="$($info.clientId)"
          $env:ARM_CLIENT_SECRET="$($info.clientSecret)"

          $env:POWER_PLATFORM_TENANT_ID="$($info.tenantId)"
          $env:POWER_PLATFORM_CLIENT_ID="$($info.clientId)"
          $env:POWER_PLATFORM_CLIENT_SECRET="$($info.clientSecret)"  
          
          azd down --no-prompt --force --purge